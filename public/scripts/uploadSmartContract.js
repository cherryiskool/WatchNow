let account;

ABI = [
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_channelName",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_videoTitle",
          "type": "string"
        },
        {
          "internalType": "address payable[]",
          "name": "_reactedToContracts",
          "type": "address[]"
        },
        {
          "internalType": "uint256[]",
          "name": "_reactedToContractsPercentageCuts",
          "type": "uint256[]"
        },
        {
          "internalType": "uint256",
          "name": "_percentageCut",
          "type": "uint256"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "inputs": [],
      "name": "applyContractTermsToDonation",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "channelName",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "percentageCut",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "reactedToContracts",
      "outputs": [
        {
          "internalType": "address payable",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "reactedToContractsPercentageCuts",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "videoTitle",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ]

const bytecode = "0x60806040523480156200001157600080fd5b506040516200104938038062001049833981810160405281019062000037919062000463565b33600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550846001908051906020019062000090929190620000ee565b508360009080519060200190620000a9929190620000ee565b508260049080519060200190620000c29291906200017f565b508160059080519060200190620000db9291906200020e565b508060028190555050505050506200074a565b828054620000fc9062000682565b90600052602060002090601f0160209004810192826200012057600085556200016c565b82601f106200013b57805160ff19168380011785556200016c565b828001600101855582156200016c579182015b828111156200016b5782518255916020019190600101906200014e565b5b5090506200017b919062000260565b5090565b828054828255906000526020600020908101928215620001fb579160200282015b82811115620001fa5782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555091602001919060010190620001a0565b5b5090506200020a919062000260565b5090565b8280548282559060005260206000209081019282156200024d579160200282015b828111156200024c5782518255916020019190600101906200022f565b5b5090506200025c919062000260565b5090565b5b808211156200027b57600081600090555060010162000261565b5090565b60006200029662000290846200057d565b62000549565b90508083825260208201905082856020860282011115620002b657600080fd5b60005b85811015620002ea5781620002cf8882620003ae565b845260208401935060208301925050600181019050620002b9565b5050509392505050565b60006200030b6200030584620005ac565b62000549565b905080838252602082019050828560208602820111156200032b57600080fd5b60005b858110156200035f57816200034488826200044c565b8452602084019350602083019250506001810190506200032e565b5050509392505050565b6000620003806200037a84620005db565b62000549565b9050828152602081018484840111156200039957600080fd5b620003a68482856200064c565b509392505050565b600081519050620003bf8162000716565b92915050565b600082601f830112620003d757600080fd5b8151620003e98482602086016200027f565b91505092915050565b600082601f8301126200040457600080fd5b815162000416848260208601620002f4565b91505092915050565b600082601f8301126200043157600080fd5b81516200044384826020860162000369565b91505092915050565b6000815190506200045d8162000730565b92915050565b600080600080600060a086880312156200047c57600080fd5b600086015167ffffffffffffffff8111156200049757600080fd5b620004a5888289016200041f565b955050602086015167ffffffffffffffff811115620004c357600080fd5b620004d1888289016200041f565b945050604086015167ffffffffffffffff811115620004ef57600080fd5b620004fd88828901620003c5565b935050606086015167ffffffffffffffff8111156200051b57600080fd5b6200052988828901620003f2565b92505060806200053c888289016200044c565b9150509295509295909350565b6000604051905081810181811067ffffffffffffffff82111715620005735762000572620006e7565b5b8060405250919050565b600067ffffffffffffffff8211156200059b576200059a620006e7565b5b602082029050602081019050919050565b600067ffffffffffffffff821115620005ca57620005c9620006e7565b5b602082029050602081019050919050565b600067ffffffffffffffff821115620005f957620005f8620006e7565b5b601f19601f8301169050602081019050919050565b60006200061b8262000622565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60005b838110156200066c5780820151818401526020810190506200064f565b838111156200067c576000848401525b50505050565b600060028204905060018216806200069b57607f821691505b60208210811415620006b257620006b1620006b8565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b62000721816200060e565b81146200072d57600080fd5b50565b6200073b8162000642565b81146200074757600080fd5b50565b6108ef806200075a6000396000f3fe6080604052600436106100555760003560e01c80630a84842b1461005a5780632443877c1461006457806374f321991461008f578063a2d48c6f146100ba578063b5cd59b4146100f7578063f4f4224614610134575b600080fd5b61006261015f565b005b34801561007057600080fd5b506100796103cd565b6040516100869190610602565b60405180910390f35b34801561009b57600080fd5b506100a461045b565b6040516100b19190610602565b60405180910390f35b3480156100c657600080fd5b506100e160048036038101906100dc9190610567565b6104e9565b6040516100ee9190610624565b60405180910390f35b34801561010357600080fd5b5061011e60048036038101906101199190610567565b61050d565b60405161012b91906105e7565b60405180910390f35b34801561014057600080fd5b5061014961054c565b6040516101569190610624565b60405180910390f35b600060048054905011156103615760005b60048054905081101561035b576000600582815481106101b9577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9060005260206000200154346101cf919061068c565b9050600060646004805490506101e5919061068c565b905060048381548110610221577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16630a84842b8284610273919061065b565b6040518263ffffffff1660e01b81526004016000604051808303818588803b15801561029e57600080fd5b505af11580156102b2573d6000803e3d6000fd5b5050505050600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc82846102ff919061065b565b60048054905034610310919061065b565b61031a91906106e6565b9081150290604051600060405180830381858888f19350505050158015610345573d6000803e3d6000fd5b5050508080610353906107bb565b915050610170565b506103cb565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc349081150290604051600060405180830381858888f193505050501580156103c9573d6000803e3d6000fd5b505b565b600180546103da90610789565b80601f016020809104026020016040519081016040528092919081815260200182805461040690610789565b80156104535780601f1061042857610100808354040283529160200191610453565b820191906000526020600020905b81548152906001019060200180831161043657829003601f168201915b505050505081565b6000805461046890610789565b80601f016020809104026020016040519081016040528092919081815260200182805461049490610789565b80156104e15780601f106104b6576101008083540402835291602001916104e1565b820191906000526020600020905b8154815290600101906020018083116104c457829003601f168201915b505050505081565b600581815481106104f957600080fd5b906000526020600020016000915090505481565b6004818154811061051d57600080fd5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60025481565b600081359050610561816108a2565b92915050565b60006020828403121561057957600080fd5b600061058784828501610552565b91505092915050565b6105998161071a565b82525050565b60006105aa8261063f565b6105b4818561064a565b93506105c4818560208601610756565b6105cd81610891565b840191505092915050565b6105e18161074c565b82525050565b60006020820190506105fc6000830184610590565b92915050565b6000602082019050818103600083015261061c818461059f565b905092915050565b600060208201905061063960008301846105d8565b92915050565b600081519050919050565b600082825260208201905092915050565b60006106668261074c565b91506106718361074c565b92508261068157610680610833565b5b828204905092915050565b60006106978261074c565b91506106a28361074c565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04831182151516156106db576106da610804565b5b828202905092915050565b60006106f18261074c565b91506106fc8361074c565b92508282101561070f5761070e610804565b5b828203905092915050565b60006107258261072c565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60005b83811015610774578082015181840152602081019050610759565b83811115610783576000848401525b50505050565b600060028204905060018216806107a157607f821691505b602082108114156107b5576107b4610862565b5b50919050565b60006107c68261074c565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156107f9576107f8610804565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000601f19601f8301169050919050565b6108ab8161074c565b81146108b657600080fd5b5056fea2646970667358221220055f36ccddb8a086b527bd7832b9a3ce80bde1ecb709eae5c28afc6ef44cd38264736f6c63430008000033"

const connectMetamask = async () => {
    if(window.ethereum !== "undefined") {
        const accounts = await ethereum.request({method: "eth_requestAccounts"});
        // this automatically checks the users wallet
        // may cause a bug if they have not entered one (will be fixed later)
        account = accounts[0];
        document.getElementById("userArea").innerHTML = `User Account: ${account}`;
    }
}
const deployContract = async (event) => {
    // stops submission from happening immediately
    event.preventDefault();

    // try this
    try {
        window.web3 =  await new Web3(window.ethereum);
        window.contract =  new window.web3.eth.Contract(ABI);

        // gets the video title from the form
        const videoTitle = String(document.getElementById("videoTitle").value)

        // gets the links to the reacted to videos
        let reactedToLinks = document.getElementsByClassName("reactedTo");

        // creates array to store contracts of reacted to videos
        let reactedToContracts = []
        let reactedToContractsCuts = []

        console.log("ReactedToLinks",reactedToLinks)
        // for every reacted to link
        for(const reactedToLink of reactedToLinks) {
            // get the filename of the video they linked to
            if(reactedToLink.value !== "") {
              let indexOfUrl = String(reactedToLink.value).indexOf("watch/");
              let reactedToFileName = String(reactedToLink.value).slice(indexOfUrl + 6);

              if (reactedToFileName == '') {
                reactedToFileName = reactedToLink.value;
              }
              // request the contract address of their video
              let req = await fetch( `/videos/upload/reactedToContractAddress/${reactedToFileName}`)
              let contractAddress = await req.json();
              console.log("contractAddress", contractAddress)
              if (!contractAddress.ok) {
                throw new Error('Invalid react link');
              } else if (contractAddress.success == true) {
                contractAddress = contractAddress.address
              }
              window.contract =  new window.web3.eth.Contract(ABI, contractAddress);
              let contractCut = await window.contract.methods.percentageCut().call();
              // add the contract address to the reacted to contracts 
              // so later we can put this in the reaction smart contract
              reactedToContracts.push(contractAddress);
              reactedToContractsCuts.push(contractCut);
            }

        }

        const channelNameRequest = await fetch('/getSessionUsername');

        const channelName = await channelNameRequest.json();
        
        console.log('channelname', channelName)


        // get the percentage cut the creator wants
        const percentageCut = Number(document.getElementById("percentageCut").value)

        // prevents invalid percentages
        if (percentageCut > 100) {
          throw new Error('Invalid percentage cut');
        } 
        // deploy the contract with all the relevant variables
        const deployment = await window.contract.deploy({
            data: bytecode,
            arguments:[channelName, videoTitle, reactedToContracts, reactedToContractsCuts, percentageCut]
        }).send({from: account, gas: 6000000})

        document.getElementById("userArea").innerHTML = 'Please wait for your contract to deploy before leaving this page...'

        // create form object from form and POST it
        const videoData = new FormData(event.target);

        const upload = await fetch('/videos/upload', {
            method: 'POST', 
            body: videoData
        });

        console.log(deployment.options.address);

        // video filename 
        const videoFilename = await upload.json();

        // may change the POST to send the data through body rather than the url
        // ^ not strictly necessary as no private data is used
        // this uses the route that saves the contract address data 
        await fetch(`/videos/upload/reactedToContractAddress/${videoFilename.filename}/${deployment.options.address}`, {
            method: 'POST'
        });

        document.getElementById("userArea").innerHTML = `Contract successfully deployed to ${deployment.options.address}`
    } 
    // in case of error log error
    // later will add some alert thingy
    catch (err) {
        alert(err);
    }
}